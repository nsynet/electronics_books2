Sunplus u'nSP Assembler - Ver. 1.6.0
              Listing File Has Been Relocated
                            	.include hardware.inc  
                     <      	//========================================================================================
                     <      	// Progarm: The file be included by modules
                     <      	// Arranged by: Andy Hsu
                     <      	// Date: 	2000/06/23: first version
                     <      	//		2000/07/24: modified
                     <      	//		2000/10/20: modified for version 52A
                     <      	//========================================================================================
                     <      	//////////////////////////////////////////////////////////////////
                     <      	// Definitions for I/O Port
                     <      	//////////////////////////////////////////////////////////////////
                     <      	.DEFINE	P_IOA_Data   		0x7000;        // Write Data into data register and read from IOA pad
                     <      	.DEFINE P_IOA_Buffer        0x7001;        // Write Data into buffer register and read from buffer register
                     <      	.DEFINE P_IOA_Dir           0x7002;        // Direction vector for IOA
                     <      	.DEFINE P_IOA_Attrib        0x7003;        // Attribute vector for IOA
                     <      	.DEFINE P_IOA_Latch         0x7004;        // Latch PortA data for key change wake-up
                     <      	
                     <      	.DEFINE P_IOB_Data         	0x7005;        // Write Data into the data register and read from IOB pad
                     <      	.DEFINE P_IOB_Buffer        0x7006;        // Write Data into buffer register and read from buffer register
                     <      	.DEFINE P_IOB_Dir           0x7007;        // Direction vector for IOB
                     <      	.DEFINE P_IOB_Attrib        0x7008;        // Attribute vector for IOB
                     <      	
                     <      	.DEFINE P_FeedBack          0x7009;        // Clock form external R,C
                     <      	.DEFINE P_TimerA_Data       0x700A;        // Data port for TimerA 
                     <      	.DEFINE P_TimerA_Ctrl       0x700B;        // Control Port for TimerA
                     <      	.DEFINE P_TimerB_Data       0x700C;        // Data port for TimerB
                     <      	.DEFINE P_TimerB_Ctrl       0x700D;        // Control Port for TimerB
                     <      	.DEFINE P_TimeBase_Setup    0x700E;        // TimerBase Freq. Set
                     <      	.DEFINE P_TimeBase_Clear	0x700F;		   // Reset Timerbase counter
                     <      	.DEFINE P_INT_Ctrl          0x7010;        // Control port for interrupt source
                     <      	.DEFINE P_INT_Clear         0x7011;        // Clear interrupt source
                     <      	.DEFINE P_Watchdog_Clear    0x7012;        // Watchdog Reset
                     <      	.DEFINE P_SystemClock       0x7013;        // Change system clock frequency(include go to standby mode)
                     <      	
                     <      	//... PA6442 Old version (for EC-02) ...........
                     <      	//.DEFINE P_ADDA               0x7014;        //10-bit DA(W) AD(R)
                     <      	//.DEFINE P_DAC1               0x7014;        //
                     <      	//.DEFINE P_AD_Ctrl            0x7015;        //AD/DA control
                     <      	//.DEFINE P_AD_Status          0x7015;        //AD status
                     <      	//.DEFINE P_DAC2               0x7016;        //DAC channel 2
                     <      	//.DEFINE P_PWM                0x7016;        //PWM output
                     <      	//.DEFINE P_DA_Ctrl            0x7017;        //DAC latch control
                     <      	
                     <      	//... PA6442 New version MC52A (For EC-03)....
                     <      	.DEFINE P_ADC 	        	0x7014;        	// Data Port for AD
                     <      	.DEFINE P_ADC_Ctrl          0x7015;        	// Control Port for AD control
                     <      	.DEFINE P_ADC_Status        0x7015;        	// AD Port Status
                     <      	.DEFINE P_DAC2              0x7016;        	// Data Port for DAC2
                     <      	.DEFINE P_PWM               0x7016;        	// Data Port for PWM
                     <      	.DEFINE P_DAC1	        	0x7017;        	// Data Port for DAC1
                     <      	.DEFINE P_DAC_Ctrl			0x702A;			// Control Port for two DAC and audio output mode
                     <      	//............................................
                     <      	
                     <      	.DEFINE P_IR_Ctrl			0x7018;			// Control Port for IR
                     <      	.DEFINE P_LVD_Ctrl          0x7019;        	// Control Port for LVD
                     <      	
                     <      	.DEFINE P_SIO_Addr_Low		0x701B;			// Address Port low
                     <      	.DEFINE P_SIO_Addr_Mid		0x701C;			// Address Port middle
                     <      	.DEFINE P_SIO_Addr_High	 	0x701D;			// Address Port high
                     <      	.DEFINE P_SIO_Ctrl			0x701E;			// Control Port
                     <      	.DEFINE P_SIO_Start			0x701F;			// Start port for serial interface
                     <      	.DEFINE P_SIO_Stop			0x7020;			// Stop port for serial interface
                     <      	
                     <      	.DEFINE P_UART_Command1		 0x7021;		// Command1 Port for UART
                     <      	.DEFINE P_UART_Command2		 0x7022;		// Command2 Port for UART
                     <      	.DEFINE P_UART_Data			 0x7023; 		// Data Port for UART
                     <      	.DEFINE	P_UART_BaudScalarLow 0x7024;		// Set Baud Rate scalar low
                     <      	.DEFINE	P_UART_BaudScalarHigh 0x7025;		// Set Baud Rate scalar high
                     <      	
                     <      	
                     <      	//... Definitions for P_INT_Ctrl ..............
                     <      	.DEFINE C_IRQ6_TMB2             0x0001;        	// Timer B IRQ6
                     <      	.DEFINE C_IRQ6_TMB1             0x0002;        	// Timer A IRQ6
                     <      	.DEFINE C_IRQ5_2Hz              0x0004;        	// 2Hz IRQ5
                     <      	.DEFINE C_IRQ5_4Hz              0x0008;        	// 4Hz IRQ5
                     <      	.DEFINE C_IRQ4_1KHz             0x0010;        	// 1024Hz IRQ4
                     <      	.DEFINE C_IRQ4_2KHz             0x0020;        	// 2048Hz IRQ4
                     <      	.DEFINE C_IRQ4_4KHz             0x0040;        	// 4096Hz IRQ4
                     <      	.DEFINE C_IRQ3_KEY              0x0080;        	// Key Change IRQ3
                     <      	.DEFINE C_IRQ3_EXT1             0x0100;        	// Ext1 IRQ3
                     <      	.DEFINE C_IRQ3_EXT2             0x0200;        	// Ext2 IRQ3
                     <      	.DEFINE C_IRQ2_TMB              0x0400;        	// Timer B IRQ2
                     <      	.DEFINE C_FIQ_TMB               0x0800;        	// Timer B FIQ
                     <      	.DEFINE C_IRQ1_TMA              0x1000;        	// Timer A IRQ1
                     <      	.DEFINE C_FIQ_TMA               0x2000;        	// Timer A FIQ
                     <      	.DEFINE C_IRQ0_PWM              0x4000;        	// PWM IRQ0
                     <      	.DEFINE C_FIQ_PWM               0x8000;        	// PWM FIQ
                     <      	
                     <      	// Definitions for P_TimerA/B_Ctrl ............                               
                     <      	.DEFINE	C_Fosc_2				0x0000;			// 
                     <      	.DEFINE	C_Fosc_256		    	0x0001;			//
                     <      	.DEFINE	C_32768Hz				0x0002;			//
                     <      	.DEFINE	C_8192Hz				0x0003;			//
                     <      	.DEFINE	C_4096Hz				0x0004;			//
                     <      	.DEFINE	C_A1					0x0005;			//
                     <      	.DEFINE C_A0					0x0006;			//
                     <      	.DEFINE C_Ext1					0x0007;			//
                     <      	
                     <      	.DEFINE	C_2048Hz				0x0000;			//
                     <      	.DEFINE	C_1024Hz				0x0008;			//
                     <      	.DEFINE	C_256Hz					0x0010;			//
                     <      	.DEFINE	C_TMB1Hz				0x0018;			//
                     <      	.DEFINE	C_4Hz					0x0020;			//
                     <      	.DEFINE	C_2Hz					0x0028;			//
                     <      	.DEFINE	C_B1					0x0030;			//
                     <      	.DEFINE	C_Ext2					0x0038;			//
                     <      	
                     <      	.DEFINE	C_Off					0x0000;			//
                     <      	.DEFINE C_D1					0x0040;			//
                     <      	.DEFINE C_D2					0x0080;			//
                     <      	.DEFINE C_D3					0x00C0;			//
                     <      	.DEFINE C_D4					0x0100;			//
                     <      	.DEFINE C_D5					0x0140;			//
                     <      	.DEFINE C_D6					0x0180;			//
                     <      	.DEFINE C_D7					0x01C0;			//
                     <      	.DEFINE C_D8					0x0200;			//
                     <      	.DEFINE C_D9					0x0240;			//
                     <      	.DEFINE C_D10					0x0280;			//
                     <      	.DEFINE C_D11					0x02C0;			//
                     <      	.DEFINE C_D12					0x0300;			//
                     <      	.DEFINE C_D13					0x0340;			//
                     <      	.DEFINE C_D14					0x0380;			//
                     <      	.DEFINE C_TA_Div_2				0x03C0;			// Timer A
                     <      	.DEFINE C_TB_Div_2				0x03C0;			// Timer B
                     <      	
                     <      	//... Definition for P_SystemClock ............
                     <      	.DEFINE C_Fosc					0x0000;			// b3..b0
                     <      	.DEFINE C_Fosc_Div_2			0x0001;			//
                     <      	.DEFINE C_Fosc_Div_4			0x0002;			//
                     <      	.DEFINE C_Fosc_Div_8			0x0003;			// (default)
                     <      	.DEFINE C_Fosc_Div_16			0x0004;			//
                     <      	.DEFINE C_Fosc_Div_32			0x0005;			//
                     <      	.DEFINE C_Fosc_Div_64			0x0006;			//
                     <      	.DEFINE C_Sleep					0x0007;		 	//
                     <      	
                     <      	.DEFINE	C_32K_Work				0x0000;			// b4
                     <      	.DEFINE C_32K_Off				0x0000;			// 
                     <      	.DEFINE C_StrongMode			0x0000;			// b5
                     <      	.DEFINE C_AutoMode				0x0000;			//
                     <      	
                     <      	//... Define for P_AD_Ctrl ....................
                     <      	.DEFINE	C_AD					0x0001;			//
                     <      	.DEFINE C_DA					0x0000;			//
                     <      	.DEFINE C_MIC					0x0000;			//
                     <      	.DEFINE C_LINE					0x0002;			//
                     <      	
                     <      	//... Define for P_DA_Ctrl ....................
                     <      	.DEFINE C_PushPull				0x0000;			// b0, (default) 
                     <      	.DEFINE C_DoubleEnd				0x0001;			// b0
                     <      	.DEFINE	C_DAC_Mode				0x0000;			// b1, (default)
                     <      	.DEFINE C_PWM_Mode				0x0002;			// b1
                     <      	
                     <      	.DEFINE	C_D1_Direct				0x0000;			// DAC1 latch
                     <      	.DEFINE C_D1_LatchA				0x0008;			// 
                     <      	.DEFINE C_D1_LatchB				0x0010;			//
                     <      	.DEFINE C_D1_LatchAB			0x0018;			//
                     <      	
                     <      	.DEFINE	C_D2_Direct				0x0000;			// DAC2 latch
                     <      	.DEFINE C_D2_LatchA				0x0020;			// 
                     <      	.DEFINE C_D2_LatchB				0x0040;			//
                     <      	.DEFINE C_D2_LatchAB			0x00C0;			//
                     <      	
                     <      	//... Define for P_LVD_Ctrl ...................
                     <      	.DEFINE C_LVD24V				0x0000;			// LVD = 2.4V 
                     <      	.DEFINE C_LVD28V				0x0001;			// LVD = 2.8V
                     <      	.DEFINE C_LVD32V				0x0002;			// LVD = 3.2V
                     <      	.DEFINE C_LVD36V				0x0003;			// LVD = 3.6V
                     <      	
                     <      	
                     <      	.EXTERNAL	F_SP_Read_INT_Status;			// for further use
                     <      	.EXTERNAL 	F_SP_Write_INT_Status;			// for further use
                     <      	.EXTERNAL  	F_SP_Set_INT_Vector;			// for further use
                     <      	.EXTERNAL	F_SP_Clear_INT_Vector;			// for further use
                     <      	
                     <      	.EXTERNAL	F_SP_Send_Out;					//
                     <      	.EXTERNAL	F_SP_Send_DAC1;					//
                     <      	.EXTERNAL	F_SP_Send_DAC2;					//
                     <      	.EXTERNAL	F_SP_Send_Two_DAC;				//
                     <      	.EXTERNAL	F_SP_Init_HW;					//
                     <      	
                     <      	.EXTERNAL	R_InterruptStatus;
                     <      	
                     <      	
                     <      	.EXTERNAL 	F_SP_RampUpDAC1;
                     <      	.EXTERNAL 	F_SP_RampDnDAC1;
                     <      	.EXTERNAL 	F_SP_RampUpDAC2;
                     <      	.EXTERNAL  	F_SP_RampDnDAC2;
                     <      	
                     <      	.EXTERNAL 	F_SP_InitQueue;
                     <      	.EXTERNAL 	F_SP_ReadQueue;
                     <      	.EXTERNAL 	F_SP_WriteQueue;
                     <      	.EXTERNAL 	F_SP_TestQueue;
                     <      	
                     <      	
                     <      	
                     <      	.EXTERNAL	F_SP_Get_ADC
                     <      	
                     <      	.EXTERNAL 	F_SP_Set_P_TimerA_Ctrl
                     <      	.EXTERNAL 	F_SP_Set_P_TimerA_Data
                     <      	.EXTERNAL 	F_SP_Set_P_TimerB_Ctrl
                     <      	.EXTERNAL 	F_SP_Set_P_TimerB_Data
                     <      	.EXTERNAL 	F_SP_Set_P_INT_Ctrl
                     <      	.EXTERNAL 	F_SP_Set_P_INT_Clear
                     <      	.EXTERNAL 	F_SP_Set_P_SystemClock
                     <      	.EXTERNAL 	F_SP_Set_P_DAC_Ctrl
                     <      	.EXTERNAL 	F_SP_Set_P_ADC_Ctrl
                     <      	
                     <      		
                     <      	
                     <      	//--------------------------------------------
                     <      	SACM_MACRO1: 	.MACRO
                     <      		
                     <      		.ENDM
                     <      	
                     <      	SACM_MACRO2:	.MACRO
                     <      		
                     <      		.ENDM
                     <      	
                     <      	
                     <      	
                     <      	
                     <      	//.define PC_Play_Enable_A2000		1    	// Enable the PC-Play function for SACM-A2000 module
                     <      	//.define PC_Play_Enable_S480		1    	// Enable the PC-Play function for SACM-S480 module
                     <      	//.define PC_Play_Enable_S240		1    	// Enable the PC-Play function for SACM-S240 module    
                     <      	//.define PC_Play_Enable_MS01		1    	// Enable the PC-Play function for SACM-MS01 module
                     <      	
                     <      	
                     <      	
                     <      	//========================================================================================        
                     <      	// End of hardware.inc
                     <      	//========================================================================================
                            	.external  _SecondAddOne
                            	.public     Year; 
                            	.public     MonDayHr; 
                            	.public     MinSec; 
                            	.public     Per500msSet; 
                            	//*********************RAM¿Õ¼äÕ¼ÓÃ*************************//
0000032D                    	.RAM
0000032D 00 00              	.var   Year          //Äê b15--if leap year
0000032E 00 00              	.var   MonDayHr      //ÔÂÈÕÊ±  b13--b10(month) b9--b5(day)  b4--b0(hour) 
0000032F 00 00              	.var   MinSec        //·ÖÃë    b12--b7(minute) b6--b1(second) b0--500ms
00000330 00 00              	.var   Per500msSet   //500ms ±êÖ¾
                            	
00009108                    	.CODE
                            	//*********************************************************//
                            	//º¯Êý:System_Initial()
                            	//ÃèÊö:¼üÅÌÉ¨Ãè³õÊ¼»¯
                            	//²ÎÊý:ÎÞ
                            	//·µ»Ø:ÎÞ
                            	//*********************************************************//
                            	.public _System_Initial;
                            	_System_Initial: .PROC
                            	//******************ÏµÍ³Ê±ÖÓ¡¢ÖÐ¶Ï*************************//
                            	
00009108 40 92              	     r1=0
00009109 19 D3 13 70        	     [P_SystemClock]=r1
                            	
0000910B 40 92              	     r1=0
0000910C 19 D3 F7 02        	     [R_InterruptStatus] = R1
0000910E 19 D3 10 70        	     [P_INT_Ctrl]=r1
00009110 48 F1              	     IRQ OFF
00009111 4C F1              	     FIQ OFF
                            	
                            	//*********************I/O¿Ú*******************************//
00009112 09 93 00 FF        		R1=0xff00
00009114 19 D3 03 70        		[P_IOA_Attrib] = R1						//A7--A0  ÊäÈë
00009116 19 D3 02 70        		[P_IOA_Dir] = R1						//A15--A8 Êä³ö
00009118 40 92              		R1 = 0x0000				
00009119 19 D3 00 70        		[P_IOA_Data] = R1
                            	     
                            	//*********************ÍòÄêÀú******************************//
0000911B 09 93 D1 07        	     R1=2001
0000911D 19 D3 2D 03        	     [Year]=R1     							//2001Äê  b15--not leap year
0000911F 09 93 20 04        	     R1=0x0420
00009121 19 D3 2E 03        	     [MonDayHr]=R1  						//1ÔÂ1ÈÕ1Ê± 
                            	                    						// b13--b10(month) b9--b5(day)  b4--b0(hour)
00009123 40 92              	     R1=0x0000      
00009124 19 D3 2F 03        	     [MinSec]=R1      						//0·Ö0Ãë    
                            	                   							//b12--b7(minute) b6--b1(second) b0--500ms
00009126 19 D3 30 03        	     [Per500msSet]=R1   
                            	  
                            	//*******************ÖÐ¶Ï**********************************//
00009128 09 93 84 00        	     r1 = C_IRQ5_2Hz+ C_IRQ3_KEY     		//2Hz+KeyUp
0000912A 11 A3 F7 02        	     r1|=[R_InterruptStatus] 
0000912C 19 D3 F7 02        		 [R_InterruptStatus] = R1
0000912E 19 D3 10 70        	     [P_INT_Ctrl]=r1
00009130 49 F1              	     IRQ ON 
                            	     
00009131 90 9A              	     retf;
                            		.ENDP;
                            	//*********************************************************//
                            	//º¯Êý:Clear_WatchDog()
                            	//ÃèÊö:¿´ÃÅ¹·Çå0
                            	//²ÎÊý:ÎÞ
                            	//·µ»Ø:ÎÞ
                            	//*********************************************************//
                            	.public _Clear_WatchDog;
                            	_Clear_WatchDog: 	.PROC
00009132 41 92              			R1=0x0001;                      	// Clear watch dog
00009133 19 D3 12 70        			[P_Watchdog_Clear]=R1;       		//
00009135 90 9A              			retf;
                            			.ENDP
                            	//*********************************************************//
                            	//º¯Êý:LightOn()
                            	//ÃèÊö:µãÁÁ·Å¹â¶þ¼«¹Ü
                            	//²ÎÊý:ÎÞ
                            	//·µ»Ø:ÎÞ
                            	//*********************************************************//
                            	.public	_LightOn;
                            	_LightOn:	.proc         					//µãÁÁIOA15 LED 	
00009136 09 93 00 80        				r1= 0x8000;
00009138 11 A3 01 70        				r1 |= [P_IOA_Buffer];
0000913A 19 D3 01 70        				[P_IOA_Buffer] = r1;
0000913C 90 9A              				retf;
                            				.endp
                            	
                            	.public	_LightOff;      					//Ï¨Ãð IOA15 LED
                            	_LightOff:	.proc
0000913D 09 93 FF 7F        				r1= 0x7FFF;
0000913F 11 B3 01 70        				r1&= [P_IOA_Buffer];
00009141 19 D3 01 70        				[P_IOA_Buffer] = r1;
00009143 90 9A              				retf;
                            				.endp
                            	//*********************************************************//
                            	//º¯Êý:Calendar_Counter()
                            	//ÃèÊö:ÍòÄêÀúµ÷Õû
                            	//²ÎÊý:500ms±êÖ¾  [Per500msSet]----0xFFFF£¬500msµ½
                            	//·µ»Ø:ÎÞ
                            	//*********************************************************//
                            	
                            	.public _Calendar_Counter
                            	 _Calendar_Counter: .proc
00009144 11 93 30 03        	        R1 = [Per500msSet];   				//500ms±êÖ¾
00009146 01 4E              	        JNZ  Update_Time;
00009147 90 9A              	        RETF;
                            	 Update_Time:
00009148 40 92              	        R1 = 0;
00009149 19 D3 30 03        	        [Per500msSet] = R1;
                            	               
                            	//**************minute & second
0000914B 11 93 2F 03        	        R1 = [MinSec];
0000914D 41 02              	        R1 += 1;            				//Ãë+1
0000914E 09 B5 7E 00        	        R2 = R1 AND 0x007E;  				//ÊÇ·ñµ½60Ãë£¿ 
00009150 0A 45 78 00        	        CMP     R2,60*2;
00009152 37 0E              	        JB      _2HzRtc_90;
00009153 09 B3 80 1F        	        R1 &= 0x1F80;               
00009155 09 03 80 00        	        R1 += 0x0080;               
                            	        
00009157 0C 99 FF FF        	        r4=0xFFFF            				//·Ö+1£¬ÖÃµ÷Õû±êÖ¾
00009159 1C D9 44 03        	        [_SecondAddOne]=r4
                            	        
0000915B 09 43 00 1E        	        CMP     R1,60*128;  				//ÊÇ·ñµ½60·Ö
0000915D 2C 0E              	        JB      _2HzRtc_90; 
                            	        
0000915E 43 02              	        r1+=0x0003;      					//ÊÖ¹¤Ð£Õý 
                            	        
                            	//**************month, day, hour
0000915F 12 95 2E 03        	        R2 = [MonDayHr];
00009161 41 04              	        R2 += 1;                    		//Ê±+1
00009162 0A B7 1F 00        	        R3 = R2 AND 0x001F;         
00009164 58 46              	        CMP  R3,24;         				//ÊÇ·ñµ½24Ð¡Ê±
00009165 21 0E              	        JB      _2HzRtc_80;
00009166 0A B5 E0 3F        	        R2& = 0x3FE0;         				//Ð¡Ê±Çå0
00009168 7A 97              	        R3 = R2 LSR 4;
00009169 63 97              	        R3 = R3 LSR 1;
0000916A 5F B6              	        R3 &= 0x001F;
                            	        
0000916B 40 F0 9A 91        	        CALL    F_GetDaysOfTheMonth;  		//¶Á±¾ÔÂÌìÊý
                            	       
0000916D 01 47              	        CMP  R3,R1;         
0000916E 17 0E              	        JB   _2HzRtc_75;
0000916F 0A B5 00 3C        	        R2 &= 0x3C00;
00009171 0A 05 00 04        	        R2 += 0x0400;             			//ÔÂ+1
00009173 0A 45 00 34        	        CMP  R2,13*1024;       				//ÔÂ³¬¹ý12£¿
00009175 10 0E              	        JB   _2HzRtc_75;
00009176 0A 95 00 04        	        R2 = 0x0400;                		//ÔÂÖÃ1
                            	//**************year
00009178 13 97 2D 03        	        R3 = [Year];
0000917A 41 06              	        R3 += 1;                 			//Äê+1
0000917B 0B B7 FF 7F        	        R3&=0x7FFF
0000917D 0B 47 1B 0C        	        CMP     R3,3099;       				//3099Äê
0000917F 02 8E              	        JBE     _2HzRtc_70;
00009180 0B 97 D1 07        	        R3 = 2001;             				//2001Äê
                            	_2HzRtc_70:
00009182 40 F0 AE 91        	        CALL F_CalcLeapYear_or_NonLeapYear  //¼ÆËãÆ½ÈòÄê£¬R3---·µ»ØÖµ
                            	                                            //ÈòÄê(b15=1) Æ½Äê(b15=0)
00009184 1B D7 2D 03        	        [Year] = R3;
                            	
                            	_2HzRtc_75:
00009186 60 04              	        R2 += 0x0020;               		//Ìì+1
                            	_2HzRtc_80:
00009187 1A D5 2E 03        	        [MonDayHr] = R2;
                            	_2HzRtc_85:
00009189 40 92              	        R1 = 0x0000;          				//R1 = 0x0000;
                            	_2HzRtc_90:
0000918A 19 D3 2F 03        	        [MinSec] = R1;
                            	        
0000918C 90 9A              	        RETF;
                            	//**************Table
                            	TB_DaysOfMonth:     						//¸ß×Ö½Ú---ÈòÄêÌìÊý, µÍ×Ö½Ú---- Æ½ÄêÌìÊý
0000918D 1F 1F              	        .DW     31*256+31;
0000918E 1F 1F              	        .DW     31*256+31;          		//1 month
0000918F 1C 1D              	        .DW     29*256+28;          		//2 month
00009190 1F 1F              	        .DW     31*256+31;          		//3 month
00009191 1E 1E              	        .DW     30*256+30;          		//4 month
00009192 1F 1F              	        .DW     31*256+31;          		//5 month
00009193 1E 1E              	        .DW     30*256+30;          		//6 month
00009194 1F 1F              	        .DW     31*256+31;          		//7 month
00009195 1F 1F              	        .DW     31*256+31;          		//8 month
00009196 1E 1E              	        .DW     30*256+30;          		//9 month
00009197 1F 1F              	        .DW     31*256+31;          		//10 month
00009198 1E 1E              	        .DW     30*256+30;          		//11 month
00009199 1F 1F              	        .DW     31*256+31;          		//12 month
                            	        
                            	//*********************************************************//
                            	//º¯Êý:F_GetDaysOfTheMonth
                            	//ÃèÊö:¼ÆËã±¾ÔÂÌìÊý
                            	//²ÎÊý:ÎÞ
                            	//·µ»Ø:R1£­£­ÌìÊý
                            	//*********************************************************// 
                            	F_GetDaysOfTheMonth:
0000919A 11 93 2E 03        	        R1 = [MonDayHr];
0000919C 79 93              	        R1 = R1 LSR 4;
0000919D 79 93              	        R1 = R1 LSR 4;
0000919E 69 93              	        R1 = R1 LSR 2;
                            	
0000919F 4F B2              	        R1 &= 0x000F;
000091A0 09 0B 8D 91        	        BP = R1 + TB_DaysOfMonth;
000091A2 C5 92              	        R1 = [BP];
                            	
000091A3 0C 99 00 80        	        R4 = 0x8000 
000091A5 14 C9 2D 03        	        TEST R4,[Year];        				//Æ½ÈòÄê£¿
000091A7 03 4E              	        JNZ   GetDaysOfTheMonth_LeapYear;
                            	        
                            	GetDaysOfTheMonth_NonLeapYear:  			//Æ½Äê
000091A8 09 B3 FF 00        	        R1 &= 0x00FF;
000091AA 90 9A              	        RETF;
                            	        
                            	GetDaysOfTheMonth_LeapYear:     			//ÈòÄê           
000091AB 79 93              	        R1 = R1 LSR 4;
000091AC 79 93              	        R1 = R1 LSR 4;
000091AD 90 9A              	        RETF;        
                            	//**************Æ½ÈòÄê¼ÆËã*********************************//
                            	//ÃèÊö:ÈòÄêÌõ¼þ:
                            	//		1¡¢ÄÜ±»400Õû³ý
                            	//		2¡¢ÄÜ±»4Õû³ý£¬µ«²»ÄÜ±»100Õû³ý
                            	//*********************************************************//         
                            	F_CalcLeapYear_or_NonLeapYear:
000091AE 03 99              	        R4=R3;
000091AF 40 48              	        CMP     R4,0;
000091B0 06 5E              	        JZ      GetDaysOfTheMonth_20;
                            	GetDaysOfTheMonth_10:
000091B1 0C 49 90 01        	        CMP     R4,400;            			//ÅÐ¶ÏÊÇ·ñÄÜ±»400Õû³ý
000091B3 06 0E              	        JB      GetDaysOfTheMonth_30;     	//²»ÄÜ±»400Õû³ý
000091B4 0C 29 90 01        	        R4 -= 400;
000091B6 46 4E              	        JNZ     GetDaysOfTheMonth_10;
                            	GetDaysOfTheMonth_20:       				//ÈòÄê£­£­ÄÜ±»400Õû³ý »ò ÄÜ±»4Õû³ýµ«²»ÄÜ±»100Õû³ýµ         
000091B7 0B A7 00 80        	        R3| = 0x8000;       				//ÈòÄê [YEAR].15=1
000091B9 90 9A              	        RETF;
                            	
                            	GetDaysOfTheMonth_30:
000091BA 0C 49 64 00        	        CMP     R4,100;       				//ÅÐ¶ÏÊÇ·ñÄÜ±»100Õû³ý
000091BC 04 0E              	        JB      GetDaysOfTheMonth_40;  		//²»ÄÜ±»100Õû³ý£¬ÅÐ¶ÏÊÇ·ñÄÜ±»4Õû³ý 
000091BD 0C 29 64 00        	        R4 -= 100;
000091BF 46 4E              	        JNZ     GetDaysOfTheMonth_30;
000091C0 02 EE              	        JMP     GetDaysOfTheMonth_50;     	//ÄÜ±»100Õû³ý£¬²»ÊÇÈòÄê  
                            	GetDaysOfTheMonth_40:
000091C1 43 C8              	        TEST    R4,0x0003;            
000091C2 4C 5E              	        JZ      GetDaysOfTheMonth_20;   	//ÄÜ±»4Õû³ý     
                            	
                            	GetDaysOfTheMonth_50:                   	//Æ½Äê [YEAR].15=0
000091C3 0B B7 FF 7F        	        R3 &= 0x7FFF;
000091C5 90 9A              	        RETF;     
                            	      .endp    
                            	
                            	//***************µ÷ÕûÊ±¼ä**********************************// 
                            	//**************Ôö¼Ó
                            	.PUBLIC  _Adjust_Time_Up
                            	_Adjust_Time_Up: .PROC
000091C6 88 DA              	      	PUSH  BP,BP TO [SP];
000091C7 08 0B 01 00        		    BP=SP+1;
000091C9 03 92              	        R1=[BP+3];    
                            	        
000091CA 40 42              	        CMP R1,0;
000091CB 0C 5E              	        JE  Adjust_Up_00
000091CC 41 42              	        CMP R1,1;
000091CD 0C 5E              	        JE  Adjust_Up_01
000091CE 42 42              	        CMP R1,2;
000091CF 0C 5E              	        JE  Adjust_Up_02
000091D0 43 42              	        CMP R1,3;
000091D1 0C 5E              	        JE  Adjust_Up_03
000091D2 44 42              	        CMP R1,4;
000091D3 0C 5E              	        JE  Adjust_Up_04
000091D4 45 42              	        CMP R1,5;
000091D5 0C 5E              	        JE  Adjust_Up_05
000091D6 88 98              	        POP BP,BP  FROM [SP];
000091D7 90 9A              	        RETF
                            	        
000091D8 80 FE E4 91        	  Adjust_Up_00:  GOTO   Adjust_Up_Time_00;           
000091DA 80 FE F4 91        	  Adjust_Up_01:  GOTO   Adjust_Up_Time_01;       
000091DC 80 FE 04 92        	  Adjust_Up_02:  GOTO   Adjust_Up_Time_02;        
000091DE 80 FE 13 92        	  Adjust_Up_03:  GOTO   Adjust_Up_Time_03;                 
000091E0 80 FE 21 92        	  Adjust_Up_04:  GOTO   Adjust_Up_Time_04;       
000091E2 80 FE 32 92        	  Adjust_Up_05:  GOTO   Adjust_Up_Time_05;             
                            	              
                            	  Adjust_Up_Time_00:    					//µ÷ÕûÄê
000091E4 13 97 2D 03        	        R3=[Year];
000091E6 0B B7 FF 7F        	        R3&=0x7FFF
000091E8 41 06              	        R3+=1;
000091E9 0B 47 1B 0C        	        CMP     R3,3099;  					//2099Äê
000091EB 02 8E              	        JBE  YearUp_NoOver
000091EC 0B 97 D1 07        	        R3=2001
                            	  YearUp_NoOver:      
000091EE 40 F0 AE 91        	        CALL F_CalcLeapYear_or_NonLeapYear;
000091F0 1B D7 2D 03        	        [Year] = R3;
000091F2 88 98              	        POP BP,BP  FROM [SP];
000091F3 90 9A              	        RETF       
                            	        
                            	  Adjust_Up_Time_01:   						//µ÷ÕûÔÂ
000091F4 13 97 2E 03        	        R3=[MonDayHr];
000091F6 0A 95 00 3C        	        R2=0x3C00;
000091F8 03 B5              	        R2&=R3;
000091F9 0A 45 00 30        	        CMP R2,12*1024;
000091FB 02 0E              	        JB  MonUp_NoOver;
000091FC 0B B7 FF 03        	        R3&=0x03FF;
                            	   MonUp_NoOver:
000091FE 0B 07 00 04        	        R3+=0x0400;
00009200 1B D7 2E 03        	        [MonDayHr]=R3;     
00009202 88 98              	        POP BP,BP FROM [SP];
00009203 90 9A              	        RETF       
                            	         
                            	  Adjust_Up_Time_02:   						//µ÷ÕûÈÕ
00009204 13 97 2E 03        	        R3=[MonDayHr];
00009206 0A 95 E0 03        	        R2=0x03E0;
00009208 03 B5              	        R2&=R3;
00009209 0A 45 E0 03        	        CMP R2,31*32;
0000920B 02 0E              	        JB  DayUp_NoOver;
0000920C 0B B7 1F 3C        	        R3&=0x3C1F;  
                            	   DayUp_NoOver:
0000920E 60 06              	        R3+=0x0020;
0000920F 1B D7 2E 03        	        [MonDayHr]=R3;      
00009211 88 98              	        POP BP,BP  FROM [SP];
00009212 90 9A              	        RETF       
                            	  
                            	  Adjust_Up_Time_03:    					//µ÷ÕûÊ±
00009213 41 96              	        r3=0x0001
00009214 13 07 2E 03        	        R3+=[MonDayHr];
00009216 5F 94              	        R2=0x001F;
00009217 03 B5              	        R2&=R3;
00009218 57 44              	        CMP R2,23;
00009219 03 8E              	        JBE  HourUp_NoOver;
0000921A 0B B7 E0 3F        	        R3&=0x3FE0;  
0000921C 40 06              	        R3+=0x0000;  
                            	   HourUp_NoOver:
0000921D 1B D7 2E 03        	        [MonDayHr]=R3;      
0000921F 88 98              	        POP BP,BP  FROM [SP];
00009220 90 9A              	        RETF       
                            	        
                            	  Adjust_Up_Time_04:    					//µ÷Õû·Ö
00009221 0B 97 80 00        	        R3=0x0080;
00009223 13 07 2F 03        	        R3+=[MinSec];
00009225 0A 95 80 1F        	        R2=0x1F80;
00009227 03 B5              	        R2&=R3;
00009228 0A 45 80 1D        	        CMP R2,59*128;
0000922A 03 8E              	        JBE  MinUp_NoOver;
0000922B 0B B7 7F 00        	        R3&=0x007F;
0000922D 40 06              	        R3+=0x0000;
                            	   MinUp_NoOver:
0000922E 1B D7 2F 03        	        [MinSec]=R3;      
00009230 88 98              	        POP BP,BP  FROM [SP];
00009231 90 9A              	        RETF       
                            	  
                            	  Adjust_Up_Time_05:    					//µ÷ÕûÃë
00009232 42 96              	        R3=0x0002;
00009233 13 07 2F 03        	        R3+=[MinSec];
00009235 0A 95 7E 00        	        R2=0x007E;
00009237 03 B5              	        R2&=R3;
00009238 0A 45 76 00        	        CMP R2,59*2;
0000923A 03 8E              	        JBE  SecUp_NoOver;
0000923B 0B B7 80 1F        	        R3&=0x1F80;
0000923D 40 06              	        R3+=0x0000;
                            	   SecUp_NoOver:
0000923E 1B D7 2F 03        	        [MinSec]=R3;      
00009240 88 98              	        POP BP,BP  FROM [SP];
00009241 90 9A              	        RETF       
                            	       .ENDP          
                            	
                            	//**************¼õÉÙ
                            	.PUBLIC  _Adjust_Time_Down
                            	_Adjust_Time_Down: .PROC
00009242 88 DA              	      	PUSH  BP,BP  TO [SP];
00009243 08 0B 01 00        		    BP=SP+1;
00009245 03 92              	        R1=[BP+3];    
                            	        
00009246 40 42              	        CMP R1,0;
00009247 0B 5E              	        JE  Adjust_Down_00
00009248 41 42              	        CMP R1,1;
00009249 0B 5E              	        JE  Adjust_Down_01
0000924A 42 42              	        CMP R1,2;
0000924B 0B 5E              	        JE  Adjust_Down_02
0000924C 43 42              	        CMP R1,3;
0000924D 0B 5E              	        JE  Adjust_Down_03
0000924E 44 42              	        CMP R1,4;
0000924F 0B 5E              	        JE  Adjust_Down_04
00009250 45 42              	        CMP R1,5;
00009251 0B 5E              	        JE  Adjust_Down_05
00009252 3B EE              	        JMP Adjust_Down_Time_Ret
                            	
00009253 80 FE 5F 92        	Adjust_Down_00: GOTO   Adjust_Down_Time_00; 
00009255 80 FE 6E 92        	Adjust_Down_01: GOTO   Adjust_Down_Time_01; 
00009257 80 FE 7F 92        	Adjust_Down_02: GOTO   Adjust_Down_Time_02; 
00009259 80 FE 90 92        	Adjust_Down_03: GOTO   Adjust_Down_Time_03; 
0000925B 80 FE 9D 92        	Adjust_Down_04: GOTO   Adjust_Down_Time_04; 
0000925D 80 FE AD 92        	Adjust_Down_05: GOTO   Adjust_Down_Time_05; 
                            	        
                            	  Adjust_Down_Time_00:    					//µ÷ÕûÄê
0000925F 13 97 2D 03        	        R3=[Year];
00009261 0B B7 FF 7F        	        R3&=0x7FFF
00009263 41 26              	        R3-=1;
00009264 0B 47 D1 07        	        CMP     R3,2001;  					//2099Äê
00009266 02 1E              	        JAE  YearDown_NoOver
00009267 0B 97 1B 0C        	        R3=3099
                            	 YearDown_NoOver:    
00009269 40 F0 AE 91        	        CALL F_CalcLeapYear_or_NonLeapYear;
0000926B 1B D7 2D 03        	        [Year] = R3;
0000926D 20 EE              	        JMP Adjust_Down_Time_Ret;
                            	        
                            	  Adjust_Down_Time_01:   					//µ÷ÕûÔÂ
0000926E 13 97 2E 03        	        R3=[MonDayHr];
00009270 0A 95 00 3C        	        R2=0x3C00;
00009272 03 B5              	        R2&=R3;
00009273 0A 45 00 04        	        CMP R2,0x0400;
00009275 04 9E              	        JA  MonDown_NoOver;
00009276 0B B7 FF 03        	        R3&=0x03FF;
00009278 0B 07 00 34        	        R3+=0x3400;     					//13,13-1=12£¨ÏÂÃæ-1£©
                            	   MonDown_NoOver:
0000927A 0B 27 00 04        	        R3-=0x0400;     					//-1 
0000927C 1B D7 2E 03        	        [MonDayHr]=R3;     
0000927E 0F EE              	        JMP Adjust_Down_Time_Ret;
                            	           
                            	  
                            	  Adjust_Down_Time_02:   					//µ÷ÕûÈÕ
0000927F 13 97 2E 03        	        R3=[MonDayHr];
00009281 0A 95 E0 03        	        R2=0x03E0;
00009283 03 B5              	        R2&=R3;
00009284 60 44              	        CMP R2,0x0020;
00009285 04 9E              	        JA  DayDown_NoOver;
00009286 0B B7 1F 3C        	        R3&=0x3C1F;
00009288 0B 07 00 04        	        R3+=0x0400;    						//32  32-1=31
                            	   DayDown_NoOver:
0000928A 60 26              	        R3-=0x0020;   
0000928B 1B D7 2E 03        	        [MonDayHr]=R3;     
0000928D 00 EE              	        JMP Adjust_Down_Time_Ret; 
                            	 
                            	  Adjust_Down_Time_Ret:
0000928E 88 98              	        POP BP,BP FROM [SP];
0000928F 90 9A              	        RETF  
                            	 
                            	  Adjust_Down_Time_03:    					//µ÷ÕûÊ±
00009290 13 97 2E 03        	        R3=[MonDayHr];
00009292 5F 94              	        R2=0x001F;
00009293 03 B5              	        R2&=R3;
00009294 40 44              	        CMP R2,0;
00009295 03 9E              	        JA  HourDown_NoOver;
00009296 0B B7 E0 3F        	        R3&=0x3FE0;
00009298 58 06              	        R3+=0x0018;
                            	   HourDown_NoOver:
00009299 41 26              	        R3-=0x001;
0000929A 1B D7 2E 03        	        [MonDayHr]=R3;     
0000929C 4F EE              	        JMP Adjust_Down_Time_Ret;  
                            	  
                            	  Adjust_Down_Time_04:    					//µ÷Õû·Ö
0000929D 13 97 2F 03        	        R3=[MinSec];
0000929F 0A 95 80 1F        	        R2=0x1F80;
000092A1 03 B5              	        R2&=R3;
000092A2 40 44              	        CMP R2,0;
000092A3 04 9E              	        JA  MinDown_NoOver;
000092A4 0B B7 7F 00        	        R3&=0x007F;
000092A6 0B 07 00 1E        	        R3+=0x1E00;    						//60   60-1=59
                            	   MinDown_NoOver:
000092A8 0B 27 80 00        	        R3-=0x0080;
000092AA 1B D7 2F 03        	        [MinSec]=R3;     
000092AC 5F EE              	        JMP Adjust_Down_Time_Ret; 
                            	  
                            	  Adjust_Down_Time_05:    					//µ÷ÕûÃë
000092AD 13 97 2F 03        	        R3=[MinSec];
000092AF 0A 95 7E 00        	        R2=0x007E;
000092B1 03 B5              	        R2&=R3;
000092B2 40 44              	        CMP R2,0;
000092B3 04 9E              	        JA  SecDown_NoOver;
000092B4 0B B7 80 1F        	        R3&=0x1F80;
000092B6 0B 07 78 00        	        R3+=0x0078;     					//60    60-1=59
                            	   SecDown_NoOver:
000092B8 42 26              	        R3-=0x0002;
000092B9 1B D7 2F 03        	        [MinSec]=R3;     
000092BB 6E EE              	        JMP Adjust_Down_Time_Ret; 
                            	  
                            	      .ENDP   
                            	 
                            	 //=============================================== 
                            	 //        ¶ÁÊ±¼ä
                            	 //===============================================      
                            	.public _ReadRealYear   //Äê£º16½øÖÆ
                            	_ReadRealYear: .proc
000092BC 09 93 FF 7F        	      R1=0x7FFF;/////////////////////////////////
000092BE 11 B3 2D 03        	      R1&=[Year];
000092C0 90 9A              	      RETF
                            	      .ENDP
                            	          
                            	.public _ReadRealMonthDay   				//ÔÂ¡¢ÈÕ
                            	_ReadRealMonthDay: .proc
000092C1 14 99 2E 03        	      r4=[MonDayHr];
000092C3 6C 93              	      R1=R4 LSR 2;    						// ÔÂ --¸ß°ËÎ»,16½øÖÆ///////////////////////
000092C4 09 B3 00 FF        	      R1&=0xFF00 
000092C6 7C 97              	      R3=R4 LSR 4     						//ÈÕ----µÍ°ËÎ»,16½øÖÆ 
000092C7 63 97              	      R3=R3 LSR 1
000092C8 5F B6              	      R3&=0x001F
000092C9 03 A3              	      R1|=R3
000092CA 90 9A              	      RETF
                            	    .ENDP
                            	
                            	.public _ReadRealHourMin    				//Ê±¡¢·Ö
                            	 _ReadRealHourMin: .proc
000092CB 14 99 2E 03        	        r4=[MonDayHr]  
000092CD 5F B8              	        r4&=0x001F     						//Ê±´æÓÚ¸ß8Î»,16½øÖÆ
000092CE 41 08              	        R4+=1
000092CF 5C 99              	        R4=R4 LSL 4
000092D0 5C 99              	        R4=R4 LSL 4
000092D1 12 95 2F 03        	        r2=[MinSec]   						//·Ö´æÓÚµÍ8Î»£¬16½øÖÆ
000092D3 0A B5 80 1F        	        r2&=0x1F80
000092D5 7A 93              	        r1=r2 lsr 4
000092D6 71 93              	        r1=r1 lsr 3
000092D7 04 A3              	        r1|=r4
000092D8 90 9A              	        retf
                            	        .endp
                            	 
                            	 .public _ReadRealSecond    				//Ãë  16½øÖÆ 
                            	 _ReadRealSecond: .proc
000092D9 0C 99 7E 00        	     r4=0x007E;
000092DB 14 B9 2F 03        	     r4&=[MinSec];
000092DD 64 93              	     r1=r4 lsr 1;
000092DE 90 9A              	     retf
                            	     .ENDP
                            	 
                            	//=======================================================
                            	 
                            	      
                            	.public _Start256HzRTC        				//´ò¿ª256HzÖÐ¶Ï
                            	_Start256HzRTC: .proc
000092DF 40 92              	      r1=0
000092E0 19 D3 0F 70        	      [P_TimeBase_Clear]=r1
000092E2 09 93 40 00        	      r1=0x0040
000092E4 19 D3 0E 70        	      [P_TimeBase_Setup]=r1      			//TMB2 CLKsour=256Hz
                            	    
000092E6 41 92              	      r1 = C_IRQ6_TMB2 ;  					//256Hz
000092E7 11 A3 F7 02        	      r1|=[R_InterruptStatus] 
000092E9 19 D3 F7 02        		  [R_InterruptStatus] = R1
000092EB 19 D3 10 70        	      [P_INT_Ctrl]=r1
000092ED 90 9A              	      retf
                            	    .endp
                            	     
                            	 .public _Stop256HzRTC           			//¹Ø±Õ256HzÖÐ¶Ï
                            	_Stop256HzRTC: .proc
000092EE 41 92              	     r1 = C_IRQ6_TMB2 ;  					//256Hz
000092EF 09 83 FF FF        	     r1^=0xFFFF        						//È¡·´ 
000092F1 11 B3 F7 02        	     r1&=[R_InterruptStatus] 
000092F3 19 D3 F7 02        		 [R_InterruptStatus] = R1
000092F5 19 D3 10 70        	     [P_INT_Ctrl]=r1  
000092F7 90 9A              	     retf
                            	     .endp    
                            	 
                            	.external  Key_Scan_Init
                            	.public _SP_GoSleep
                            	_SP_GoSleep: .PROC
000092F8 09 93 FF 00        		    R1=0x00ff;	           				//µÈ´ý¼üÊÍ·Å
000092FA 11 B3 00 70        	        R1 &= [P_IOA_Data];	
000092FC 0F 4E              	        jnz    WaitKeyUp;
000092FD 40 F0 3A 94        	        call Key_Scan_Init
                            	       
000092FF 11 93 04 70        	        r1 = [P_IOA_Latch];     			//Ëø´æÊý¾Ý
00009301 11 93 04 70        			r1 = [P_IOA_Latch];	 
00009303 57 92              			r1 = 0x0017;            			//ÈõÕñ¡¢Í£Ö¹Ë¯Ãß
00009304 19 D3 13 70        			[P_SystemClock] = r1;
00009306 60 92              		      R1=32           					//ÑÓÊ±
                            	  WakeUpWaitDelay:      
00009307 41 22              	          r1-=1
00009308 42 4E              	          jnz WakeUpWaitDelay 	
00009309 40 92              	          r1=0
0000930A 19 D3 13 70        	          [P_SystemClock]=r1    			//¹Ø±Õ32768HÊ±ÖÓ¡¢CPUCLKÎªFosc
                            	WaitKeyUp:   
0000930C 90 9A              			retf;  	              
                            			.ENDP
0 error(s), 0 warning(s).

