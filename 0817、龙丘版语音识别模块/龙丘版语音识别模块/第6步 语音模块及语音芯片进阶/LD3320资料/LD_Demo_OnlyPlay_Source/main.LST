C51 COMPILER V7.06   MAIN                         02/28/2011 19:00:09 PAGE 1   


C51 COMPILER V7.06, COMPILATION OF MODULE MAIN
OBJECT MODULE PLACED IN main.OBJ
COMPILER INVOKED BY: C:\Keil\C51\BIN\C51.EXE main.c OPTIMIZE(SIZE) BROWSE DEBUG
                    - OBJECTEXTEND PAGEWIDTH(79) PAGELENGTH(66)

stmt level    source

   1          /****************************************************************
             -********************/
   2          //      °æÈ¨ËùÓÐ£ºCopyright (c) 2005 - 2010 ICRoute INC.
   3          /****************************************************************
             -********************/
   4          
   5          #include "STC10F08XE.H"
   6          #include "LDchip.h"
   7          #include "Reg_RW.h"
   8          #include "FlashDef.h"
   9          
  10          sbit LED1=P3^4;
  11          sbit LED2=P3^5;
  12          
  13          /****************************************************************
             -********************/
  14          //      nAsrStatus ÓÃÀ´ÔÚmainÖ÷³ÌÐòÖÐ±íÊ¾³ÌÐòÔËÐÐµÄ×´Ì¬£¬²»ÊÇLD3320Ð¾Æ
             -¬ÄÚ²¿µÄ×´Ì¬¼Ä´æÆ÷
  15          //      LD_ASR_NONE:            ±íÊ¾Ã»ÓÐÔÚ×÷ASRÊ¶±ð
  16          //      LD_ASR_RUNING£º         ±íÊ¾LD3320ÕýÔÚ×÷ASRÊ¶±ðÖÐ
  17          //      LD_ASR_FOUNDOK:         ±íÊ¾Ò»´ÎÊ¶±ðÁ÷³Ì½áÊøºó£¬ÓÐÒ»¸öÊ¶±ð½á¹û
  18          //      LD_ASR_FOUNDZERO:       ±íÊ¾Ò»´ÎÊ¶±ðÁ÷³Ì½áÊøºó£¬Ã»ÓÐÊ¶±ð½á¹û
  19          //      LD_ASR_ERROR:           ±íÊ¾Ò»´ÎÊ¶±ðÁ÷³ÌÖÐLD3320Ð¾Æ¬ÄÚ²¿³öÏÖ²»ÕýÈ·µÄ×´Ì
             -¬
  20          /****************************************************************
             -*******************/
  21          uint8 idata nAsrStatus=0;       
  22          
  23          uint8 idata nDemoFlag=0;
  24          
  25          
  26          /****************************************************************
             -********************/
  27          //      ÒÔÏÂ¶¨ÒåÊÇÔÚÊ¾·¶³ÌÐòÖÐ£¬ÓÃÀ´²¥·ÅµÄÉùÒôÊý¾ÝµÄÆðÊ¼Î»ÖÃºÍ³¤¶È
  28          //      ÕâÐ©ÉùÒôÊÇÊÂÏÈÔÚPC»úÉÏÂ¼ÖÆºÃµÄMP3ÎÄ¼þ£¬ÔÚPC»úÉÏºÏ³Éµ½Ò»¸öÎÄ¼þ 
             -voice.datÖÐ
  29          //      ¿ÉÒÔ°ÑÕâ¸övoide.dat´æ´¢µ½ÓÃ»§ÏµÍ³ÖÐµÄ´æ´¢Ð¾Æ¬ÖÐ£¬ÖîÈç spi-flas
             -hÖÐ
  30          //      ÔÚÐèÒª²¥·ÅÊ±£¬ÓÃ»§µÄÖ÷¿ØMCU¿ÉÒÔµ½spi-flashÖÐ¸ù¾ÝÒª²¥·ÅÎÄ¼þµÄÆð
             -Ê¼µØÖ·ÎÞ¶ÁÈ¡MP3Êý¾Ý
  31          //      ²¢ËÍÈëLD3320½øÐÐ²¥·Å
  32          /****************************************************************
             -********************/
  33          #define MP3_BEIJING_START       0x0000;
  34          #define MP3_BEIJING_SIZE        0x08b8;
  35          #define MP3_SHANGHAI_START      0x1000;
  36          #define MP3_SHANGHAI_SIZE       0x0ab0;
  37          #define MP3_TIANJIN_START       0x2000;
  38          #define MP3_TIANJIN_SIZE        0x0a20;
  39          #define MP3_CHONGQING_START     0x3000;
  40          #define MP3_CHONGQING_SIZE      0x0990;
  41          #define MP3_DING_START  0x4000;
  42          #define MP3_DING_SIZE   0x0828;
  43          #define MP3_NIHAO_START 0x5000;
  44          #define MP3_NIHAO_SIZE  0x1170;
  45          
C51 COMPILER V7.06   MAIN                         02/28/2011 19:00:09 PAGE 2   

  46          
  47          extern void          _nop_     (void);
  48          
  49          void MCU_init();
  50          void FlashLED(uint8 nTimes);
  51          void PlaySound(uint8 nCode);
  52          uint8 RunASR();
  53          void ProcessInt0();
  54          
  55          void PlayDemoSound_Once();
  56          void PlayDemoSound_Continue();
  57          
  58          
  59          /****************************************************************
             -********************/
  60          //      Õâ¸öÊ¾·¶³ÌÐòÊÇ»ùÓÚSTC10L08XE±àÒëµÄÍêÕûµØ£¬¿ÉÒÔÖ´ÐÐµÄ³ÌÐò
  61          //      ÊµÏÖÁË´ÓÊý×éÖÐ²¥·ÅµÄ¹¦ÄÜ
  62          //  
  63          //  verygood.mp3ÊÇÒ»¶ÎMP3¸ñÊ½µÄÉùÒôÎÄ¼þ£¬²¥·ÅÄÚÈÝÎªÓ¢ÎÄµ¥´Ê"very 
             -good"
  64          //      demosound.h ÖÐ¶¨ÒåÁËÊý×é bpDemoSound[]£¬Êý×éµÄÄÚÈÝ¾ÍÊÇ verygoo
             -d.mp3 ÎÄ¼þµÄÄÚÈÝ
  65          //  ÓÃ»§¿ÉÒÔÓÃ16½øÖÆÔÄ¶ÁÆ÷£¨±ÈÈç UltraEdit £©´ò¿ªverygood.mp3ÎÄ¼þ
             -ºÍ bpDemoSound Êý×éÏà¶ÔÕÕ
  66          //  
  67          //  PlayDemoSound_Once/PlayDemoSound_Continue º¯Êý¾ÍÊÇ°Ñ bpDemoSo
             -undÊý×éÖÐµÄÊý¾ÝÒÀ´Î´«ÈëLD3320Ð¾Æ¬½øÐÐ²¥·Å
  68          //
  69          //  ÓëLD3320Ð¾Æ¬ÓÐ¹ØµÄº¯Êý¹¦ÄÜ£¬¶¼ÔÚ"¿ª·¢ÊÖ²á.pdf"ÖÐÓÐÏêÏ¸ËµÃ÷
  70          //      Çë¿ª·¢Õß¶ÔÕÕ"¿ª·¢ÊÖ²á.pdf¡°ÔÄ¶Á
  71          //      
  72          //      ¿ª·¢ÕßÔÚÑ§Ï°LD3320¿ªÊ¼Ê±£¬¿ÉÒÔÖ±½Ó°ÑÔÚÕâ¸ömainº¯Êý¿½±´µ½×Ô¼ºµ¥
             -Æ¬»úÖÐ±àÒëÔËÐÐ
  73          //      
  74          //      µ±È»£¬ÓÃ»§Òª¸ù¾Ý×Ô¼ºÊµ¼ÊµÄµ¥Æ¬»úÈ¥ÐÞ¸Ä mcu_init £¬ÒÔ¼°¶ÔÓ¦µÄ¹Ü
             -½ÅÁ¬½ÓµÄ¶¨Òå£¬ÖÐ¶Ï¶¨Òå
  75          /****************************************************************
             -********************/
  76          
  77          void  main()
  78          {
  79   1      //      uint8 idata nAsrRes;
  80   1              uint8 nTemp;
  81   1      
  82   1              FlashLED(3);
  83   1      
  84   1              MCU_init();
  85   1              LD_reset();
  86   1      
  87   1              // ÒÔÏÂ2ÐÐÖ»ÄÜÓÐÒ»ÌõÓÐÐ§£¬
  88   1              // ¹¦ÄÜ·Ö±ðÊÇ²¥·ÅÒ»´ÎºÍÁ¬Ðø²»Í£²¥·Å¡£
  89   1              //PlayDemoSound_Once();         //      Ö®²¥·ÅÒ»´Î
  90   1              PlayDemoSound_Continue();       //      Á¬ÐøÑ­»·²¥·Å
  91   1      
  92   1              while(1)
  93   1              {
  94   2                      nTemp++;
  95   2              }// while
  96   1      
  97   1      }
  98          
  99          void MCU_init()
 100          {
 101   1              P1M0 |= 1;
C51 COMPILER V7.06   MAIN                         02/28/2011 19:00:09 PAGE 3   

 102   1              P3M0 |= 8;
 103   1      
 104   1              LED1=0;
 105   1              LED2=0;
 106   1              P0 = 0xff;
 107   1              P1 = 0xff;
 108   1              P2 = 0xff;
 109   1              P3 = 0xf7;
 110   1              P4 = 0x0f;
 111   1      
 112   1      #if defined (SOFT_SPI_PORT)             //      Èí¼þÄ£ÄâSPI¶ÁÐ´
                      LD_MODE = 1;                            //      ÉèÖÃMD¹Ü½ÅÎª¸ß
              #elif defined (HARD_SPI_PORT)   //      Ó²¼þÊµÏÖSPI¶ÁÐ´
                      LD_MODE = 1;                            //      ÉèÖÃMD¹Ü½ÅÎª¸ß
              #else                                                   //      ²¢ÐÐ¶ÁÐ´ £¨Ó²¼þÊµÏÖ»òÕßÈí¼þÄ£Äâ£©
 117   1              LD_MODE = 0;                            //      ÉèÖÃMD¹Ü½ÅÎªµÍ
 118   1      #endif
 119   1      
 120   1      
 121   1              IP=0;
 122   1              IPH=0;
 123   1      
 124   1              PX0=1; 
 125   1              PT0=1;
 126   1              PS=1;
 127   1              IPH |= 1;       
 128   1              
 129   1              EX0=0;
 130   1              EX1=0;
 131   1              EA=1;
 132   1      }
 133          
 134          void  delay(unsigned long uldata)
 135          {
 136   1              unsigned int j  =  0;
 137   1              unsigned int g  =  0;
 138   1              for (j=0;j<5;j++)
 139   1              {
 140   2                      for (g=0;g<uldata;g++)
 141   2                      {
 142   3                              _nop_();
 143   3                              _nop_();
 144   3                              _nop_();
 145   3                      }
 146   2              }
 147   1      }
 148          
 149          void FlashLED(uint8 nTimes)
 150          {
 151   1              uint8 k;
 152   1              for (k=0; k<nTimes; k++)
 153   1              {
 154   2                      LED1=0;
 155   2                      LED2=0;
 156   2                      delay(15000);
 157   2                      LED1=1;
 158   2                      LED2=1;
 159   2                      delay(15000);
 160   2              }
 161   1      }
 162          
 163          /****************************************************************
             -********************/
 164          // Õâ2¸öº¯Êý½á¹¹ÏàÍ¬£¬Ö»ÊÇ¶ÔÖÕÖ¹Ìõ¼þÓÐÒ»µãÇø±ð¡£
C51 COMPILER V7.06   MAIN                         02/28/2011 19:00:09 PAGE 4   

 165          // nDemoFlag ÊÇÒ»¸ö±êÖ¾Öµ£¬Èç¹û=1¾ÍÊÇÖ´ÐÐ´ÓÄÚ´æÀï¶ÁÊý¾Ý£¬¶ø²»È¥¶Á
             -FlashÁË¡£
 166          // ÔØÈëÊý¾Ýº¯ÊýLD_ReloadMp3Data()Àï£¬ÓÐÒÔÏÂ´úÂë£º
 167          //                      val = bpDemoSound[nMp3Pos++];
 168          //                      LD_WriteReg(0x01,val);
 169          //                      if (nMp3Pos == DEMO_SOUND_SIZE)
 170          //                              nMp3Pos = 0;
 171          // ÕâÀï£¬µ± nMp3Pos ÀÛ¼ÓºóµÈÓÚ DEMO_SOUND_SIZE Ê±£¬¾ÍÉèÎª0£»
 172          // ËùÒÔÈç¹û nMp3Size ÉèÎª DEMO_SOUND_SIZE£¬ ¾ÍÓÀÔ¶²»»áÂú×ã
 173          //               if(nMp3Pos>=nMp3Size) {
 174          //                      // B. ÉùÒôÊý¾ÝÒÑ·¢ËÍÍê±Ï¡£
 175          // ÉùÒô¾Í»áÒ»Ö±²¥·ÅÏÂÈ¥¡£
 176          //
 177          // Èç¹û nMp3Size ¼õÐ¡£¬µÚÒ»´Î²¥·ÅÍêºó¾ÍÂú×ãÌõ¼þÁË£¬²¥·Å¾ÍÍ£Ö¹ÁË¡£
 178          /****************************************************************
             -********************/
 179          
 180          //#define DEMO_SOUND_SIZE 851
 181          #define DEMO_SOUND_SIZE 1235
 182          
 183          void PlayDemoSound_Once()
 184          {
 185   1              nDemoFlag = 1;
 186   1              nMp3StartPos = 0;
 187   1              nMp3Size = DEMO_SOUND_SIZE-1;
 188   1              LD_Init_MP3();
 189   1              LD_AdjustMIX2SPVolume(7);
 190   1              LD_play();
 191   1      }
 192          
 193          void PlayDemoSound_Continue()
 194          {
 195   1              nDemoFlag = 1;
 196   1              nMp3StartPos = 0;
 197   1              nMp3Size = DEMO_SOUND_SIZE;
 198   1              LD_Init_MP3();
 199   1              LD_AdjustMIX2SPVolume(7);
 200   1              LD_play();
 201   1      }
 202          
 203          
 204          /****************************************************************
             -********************/
 205          //      IO_Send_Byte()ÊÇÖ÷¿ØMCUÏòspi-flash (ÐÍºÅÎª»ª°îµÄ W25X40)·¢ËÍÖ¸
             -Áî
 206          //      ¿ª·¢ÕßÓ¦¸Ã¸ù¾Ý×Ô¼ºÊ¹ÓÃµÄ´æ´¢Ð¾Æ¬È¥Ð´¾ßÌåµÄº¯Êý
 207          //
 208          //      ICroute¹«Ë¾ÎÞ·¨¶Ô´æ´¢Ð¾Æ¬µÄ¶ÁÐ´Ìá¹©¼¼ÊõÖ§³Ö£¬
 209          //      ¿ª·¢ÕßÐèÒª×Ô¼ºÏò×Ô¼ºÊ¹ÓÃµÄ´æ´¢Ð¾Æ¬µÄ³§ÉÌ»ñµÃ¼¼ÊõÖ§³Ö
 210          //      »òÕßÔÚÍøÂçÉÏËÑË÷Ïà¹Ø´úÂëºÍÎÄµµ
 211          //
 212          //      »ª°îµÄspi-flashµÄ¼¼ÊõÖ§³ÖµÄÎÄµµÒ³ÃæÔÚ£º
 213          //      http://www.winbond.com.tw/hq/cht/ProductAndSales/ProductLines/
             -FlashMemory/SerialFlash/
 214          //      http://www.xtdpj.com/show_hdr.php?xname=915RL41&dname=23T0M41&
             -xpos=84
 215          /****************************************************************
             -********************/
 216          
 217          void IO_Send_Byte(uint8 dataout)
 218          {
 219   1               uint8 i = 0; 
 220   1               FLASH_CS = 0;
 221   1               for (i=0; i<8; i++)
C51 COMPILER V7.06   MAIN                         02/28/2011 19:00:09 PAGE 5   

 222   1               {
 223   2                        if ((dataout & 0x80) == 0x80) 
 224   2                                 FLASH_DIO = 1;
 225   2                        else
 226   2                                 FLASH_DIO = 0;
 227   2                        FLASH_CLK = 1;
 228   2                        dataout = (dataout << 1); 
 229   2                        FLASH_CLK = 0;   
 230   2               }
 231   1      }
 232          
 233          
 234          void ExtInt0Handler(void) interrupt 0  
 235          {
 236   1              ProcessInt0();                          //      LD3320 ËÍ³öÖÐ¶ÏÐÅºÅ£¬°üÀ¨ASRºÍ²¥·ÅMP3µÄÖÐ¶Ï
             -£¬ÐèÒªÔÚÖÐ¶Ï´¦Àíº¯ÊýÖÐ·Ö±ð´¦Àí
 237   1      }
 238          
 239          
 240          


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    327    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =   ----    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =   ----       9
   IDATA SIZE       =      2    ----
   BIT SIZE         =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
