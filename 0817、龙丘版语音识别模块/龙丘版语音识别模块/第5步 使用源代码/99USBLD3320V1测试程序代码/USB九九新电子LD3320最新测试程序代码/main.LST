C51 COMPILER V8.18   MAIN                                                                  08/13/2011 17:58:06 PAGE 1   


C51 COMPILER V8.18, COMPILATION OF MODULE MAIN
OBJECT MODULE PLACED IN main.OBJ
COMPILER INVOKED BY: C:\Keil\C51\BIN\C51.EXE main.c OPTIMIZE(SIZE) BROWSE DEBUG OBJECTEXTEND

line level    source

   1          
   2          #include "STC10F08XE.H"
   3          #include "config.h"
   4          #include "LDchip.h"
   5          #include "uart.h"
   6          
   7          sbit LED1=P3^4;
   8          sbit LED2=P3^5;
   9          sbit BUZZ=P4^1;
  10          
  11          sbit TLED1=P4^0;
  12          sbit TLED2=P2^1;
  13          sbit TLED3=P2^2;
  14          sbit TLED4=P2^3;
  15          sbit TLED5=P2^4;
  16          sbit TLED6=P2^5;
  17          sbit TLED7=P2^7;
  18          sbit LD_MODE    = P1^0;
  19          uint8 idata nAsrStatus=0;                                                                                                                       
  20          
  21          //****************宏定义*******************
  22          #define MP3_BEIJING_START       0x0000;
  23          #define MP3_BEIJING_SIZE        0x0868;
  24          #define MP3_SHANGHAI_START      0x0C00;
  25          #define MP3_SHANGHAI_SIZE       0x0ab0;
  26          #define MP3_TIANJIN_START       0x1800;
  27          #define MP3_TIANJIN_SIZE        0x0a20;
  28          #define MP3_CHONGQING_START     0x2400;
  29          #define MP3_CHONGQING_SIZE      0x0990;
  30          #define MP3_NIHAO_START 0x3000;
  31          //#define MP3_NIHAO_SIZE        0x1170; //原始地址
  32          #define MP3_NIHAO_SIZE  0x4170; //原始地址
  33          //***********函数声明**********************
  34          extern void          _nop_     (void);
  35          void MCU_init();
  36          void FlashLED(uint8 nTimes);
  37          void PlaySound(uint8 nCode);
  38          uint8 RunASR();
  39          
  40          void  main()
  41          {
  42   1              uint8 idata nAsrRes;
  43   1              BUZZ=1;
  44   1              FlashLED(3);
  45   1              LD_MODE=0;
  46   1              MCU_init();
  47   1              LD_MODE=0;
  48   1              LD_reset();
  49   1              LD_MODE=0;
  50   1              UartInit();
  51   1              UartSendStr("STC10L08XE串口测试");
  52   1              nAsrStatus = LD_ASR_NONE;
  53   1      //      PlaySound(CODE_KONGTIAO);
  54   1          BUZZ=1;
  55   1              TLED1=0;TLED2=0;TLED3=0;TLED4=0;TLED5=0;TLED6=0;TLED7=0;
C51 COMPILER V8.18   MAIN                                                                  08/13/2011 17:58:06 PAGE 2   

  56   1              delay(20000);
  57   1              BUZZ=0;
  58   1              TLED1=1;TLED2=1;TLED3=1;TLED4=1;TLED5=1;TLED6=1;TLED7=1;        
  59   1              while(1)
  60   1              {
  61   2                      if (bMp3Play!=0)
  62   2                              continue;
  63   2      
  64   2                      switch(nAsrStatus)
  65   2                      {
  66   3                              case LD_ASR_RUNING:             //自动识别运行状态  
  67   3                              case LD_ASR_ERROR:              //自动识别错误
  68   3                                      break;
  69   3                              case LD_ASR_NONE:               //没有识别到语音
  70   3                              {
  71   4                                      FlashLED(4);
  72   4                                      nAsrStatus=LD_ASR_RUNING;
  73   4                                      
  74   4                                      if (RunASR()==0)
  75   4                                      {
  76   5                                              nAsrStatus = LD_ASR_ERROR;
  77   5                                              LED1=0;
  78   5                                              LED2=0;                                 
  79   5                                              //MCU_init();
  80   5                              LD_reset();
  81   5                              //UartInit();
  82   5                              //              UartSendStr("STC10L08XE死机重启");
  83   5                                              nAsrStatus = LD_ASR_NONE;
  84   5                          //  PlaySound(CODE_KONGTIAO);                  
  85   5                                      }
  86   4                                      break;
  87   4                              }
  88   3                              case LD_ASR_FOUNDOK:   //找到识别语音
  89   3                              {                                                                               
  90   4                                      FlashLED(2);    
  91   4                                      nAsrRes = LD_GetResult();
  92   4                                      if(nAsrRes!=CODE_ERROR)//如果不是为误识别
  93   4                                      {
  94   5                                              PlaySound(nAsrRes);
  95   5                                              delay(100);
  96   5                                              PlaySound(nAsrRes);
  97   5                                              BUZZ=1;
  98   5                              delay(10000);
  99   5                              BUZZ=0;
 100   5                                              delay(8000);
 101   5                                              BUZZ=1;
 102   5                              delay(10000);
 103   5                              BUZZ=0;
 104   5                                      }
 105   4                                      nAsrStatus = LD_ASR_NONE;
 106   4                                      break;
 107   4                              }
 108   3                              case LD_ASR_FOUNDZERO://找到0个匹配语音
 109   3                              default:
 110   3                              {
 111   4                                      FlashLED(1);
 112   4                              //      PlaySound(CODE_DEFAULT);
 113   4                                      nAsrStatus = LD_ASR_NONE;// 无语音识别
 114   4                                      break;
 115   4                              }
 116   3                      }// switch
 117   2              }// while
C51 COMPILER V8.18   MAIN                                                                  08/13/2011 17:58:06 PAGE 3   

 118   1      
 119   1      }
 120          
 121          /**************************************************************** 
 122          函数名称： MCU_init 
 123          功    能： MCU初始化
 124          入口参数： 无 
 125          返回值  ： 无
 126          修    改： 2010-2-2
 127          ****************************************************************/ 
 128          void MCU_init(void)
 129          {
 130   1              LED1=0;
 131   1              LED2=0;
 132   1              P0 = 0xff;
 133   1              P1 = 0xff;
 134   1              P2 = 0xff;
 135   1              P3 = 0xf7;
 136   1              P4 = 0x0f;
 137   1      
 138   1              IP=0;
 139   1              IPH=0;
 140   1      
 141   1              PX0=1; 
 142   1              PT0=1;
 143   1              PS=1;
 144   1              IPH |= 1;       
 145   1              
 146   1              EX0=0;
 147   1              EX1=0;
 148   1              ET0=0;
 149   1              EA=1;
 150   1      }
 151          
 152          /**************************************************************** 
 153          函数名称： FlashLED 
 154          功    能： 控制LED
 155          入口参数： nTimes 
 156          返回值  ： 无
 157          修    改： 2010-2-2
 158          ****************************************************************/ 
 159          void FlashLED(uint8 nTimes)
 160          {
 161   1              uint8 k;
 162   1              for (k=0; k<nTimes; k++)
 163   1              {
 164   2                      LED1=0;
 165   2                      LED2=0;
 166   2                      delay(15000);
 167   2                      LED1=1;
 168   2                      LED2=1;
 169   2                      delay(15000);
 170   2              }
 171   1      }
 172          
 173          /**************************************************************** 
 174          函数名称： PlaySound 
 175          功    能： 按要求播放语音
 176          入口参数： nCode 
 177          返回值  ： 无
 178          修    改： 2010-2-2
 179          ****************************************************************/
C51 COMPILER V8.18   MAIN                                                                  08/13/2011 17:58:06 PAGE 4   

 180          void PlaySound(uint8 nCode)
 181          {
 182   1              unsigned char Buff_Dat[5]={0x1b,0x21,0x51,0xD0,0x00}; 
 183   1              switch(nCode)
 184   1              {
 185   2              case CODE_FSK:
 186   2                      nMp3StartPos = MP3_BEIJING_START;
 187   2                      nMp3Size = MP3_BEIJING_SIZE;
 188   2                      TLED1=0;
 189   2                      break;
 190   2              case CODE_FSG:
 191   2                      nMp3StartPos = MP3_BEIJING_START;
 192   2                      nMp3Size = MP3_BEIJING_SIZE;
 193   2                      TLED1=1;
 194   2                      break;
 195   2              case CODE_TDK:
 196   2                      nMp3StartPos = MP3_BEIJING_START;
 197   2                      nMp3Size = MP3_BEIJING_SIZE;
 198   2                      TLED2=0;
 199   2                      break;
 200   2              case CODE_TDG:
 201   2                      nMp3StartPos = MP3_BEIJING_START;
 202   2                      nMp3Size = MP3_BEIJING_SIZE;
 203   2                      TLED2=1;
 204   2                      break;
 205   2              case CODE_CJS:
 206   2                      nMp3StartPos = MP3_SHANGHAI_START;
 207   2                      nMp3Size = MP3_SHANGHAI_SIZE;
 208   2                      TLED3=0;
 209   2                      break;
 210   2              case CODE_CJJ:
 211   2                      nMp3StartPos = MP3_SHANGHAI_START;
 212   2                      nMp3Size = MP3_SHANGHAI_SIZE;
 213   2                      TLED3=1;
 214   2                      break;
 215   2              case CODE_TINGDENGK:
 216   2                      nMp3StartPos = MP3_SHANGHAI_START;
 217   2                      nMp3Size = MP3_SHANGHAI_SIZE;
 218   2                      TLED4=0;
 219   2                      break;
 220   2              case CODE_TINGDENGG:
 221   2                      nMp3StartPos = MP3_SHANGHAI_START;
 222   2                      nMp3Size = MP3_SHANGHAI_SIZE;
 223   2                      TLED4=1;
 224   2                      break;
 225   2              case CODE_FANGDENGK:
 226   2                      nMp3StartPos = MP3_TIANJIN_START;
 227   2                      nMp3Size = MP3_TIANJIN_SIZE;
 228   2                      TLED5=0;
 229   2                      break;
 230   2              case CODE_FANGDENGG:
 231   2                      nMp3StartPos = MP3_TIANJIN_START;
 232   2                      nMp3Size = MP3_TIANJIN_SIZE;
 233   2                      TLED5=1;
 234   2                      break;
 235   2              case CODE_LIUHAOK:
 236   2                      nMp3StartPos = MP3_CHONGQING_START;
 237   2                      nMp3Size = MP3_CHONGQING_SIZE;
 238   2                      TLED6=0;
 239   2                      break;
 240   2              case CODE_LIUHAOG:
 241   2                      nMp3StartPos = MP3_CHONGQING_START;
C51 COMPILER V8.18   MAIN                                                                  08/13/2011 17:58:06 PAGE 5   

 242   2                      nMp3Size = MP3_CHONGQING_SIZE;
 243   2                      TLED6=1;
 244   2                      break;
 245   2              case CODE_QIHAOK:
 246   2                      nMp3StartPos = MP3_NIHAO_START;
 247   2                      nMp3Size = MP3_NIHAO_SIZE;
 248   2                      TLED7=0;
 249   2                      break;
 250   2              case CODE_QIHAOG:
 251   2                      nMp3StartPos = MP3_NIHAO_START;
 252   2                      nMp3Size = MP3_NIHAO_SIZE;
 253   2                      TLED7=1;
 254   2                      break;
 255   2              //=====================================================================7
 256   2              /*case CODE_BAHAOK:
 257   2                      nMp3StartPos = MP3_BEIJING_START;
 258   2                      nMp3Size = MP3_BEIJING_SIZE;
 259   2                      //UartSendStr("风扇");
 260   2                      Buff_Dat[2]=0x58;
 261   2                      Buff_Dat[3]=0xD1;
 262   2                      break;
 263   2              case CODE_BAHAOG:
 264   2                      nMp3StartPos = MP3_BEIJING_START;
 265   2                      nMp3Size = MP3_BEIJING_SIZE;
 266   2                      //UartSendStr("风扇");
 267   2                      Buff_Dat[2]=0x58;
 268   2                      Buff_Dat[3]=0xD0;
 269   2                      break;
 270   2              case CODE_JIUHAOK:
 271   2                      nMp3StartPos = MP3_SHANGHAI_START;
 272   2                      nMp3Size = MP3_SHANGHAI_SIZE;
 273   2                      //UartSendStr("风扇");
 274   2                      Buff_Dat[2]=0x59;
 275   2                      Buff_Dat[3]=0xD1;
 276   2                      break;
 277   2              case CODE_JIUHAOG:
 278   2                      nMp3StartPos = MP3_SHANGHAI_START;
 279   2                      nMp3Size = MP3_SHANGHAI_SIZE;
 280   2                      //UartSendStr("风扇");
 281   2                      Buff_Dat[2]=0x59;
 282   2                      Buff_Dat[3]=0xD0;
 283   2                      break;
 284   2              case CODE_DDCLK:
 285   2                      nMp3StartPos = MP3_SHANGHAI_START;
 286   2                      nMp3Size = MP3_SHANGHAI_SIZE;
 287   2                      //UartSendStr("台灯");
 288   2                      Buff_Dat[2]=0x5A;
 289   2                      Buff_Dat[3]=0xD1;
 290   2                      break;
 291   2              case CODE_DDCLG:
 292   2                      nMp3StartPos = MP3_SHANGHAI_START;
 293   2                      nMp3Size = MP3_SHANGHAI_SIZE;
 294   2                      //UartSendStr("台灯");
 295   2                      Buff_Dat[2]=0x5A;
 296   2                      Buff_Dat[3]=0xD0;
 297   2                      break;
 298   2              case CODE_SHIYIHAOK:
 299   2                      nMp3StartPos = MP3_TIANJIN_START;
 300   2                      nMp3Size = MP3_TIANJIN_SIZE;
 301   2                      //UartSendStr("电动窗");
 302   2                      Buff_Dat[2]=0x5B;
 303   2                      Buff_Dat[3]=0xD1;
C51 COMPILER V8.18   MAIN                                                                  08/13/2011 17:58:06 PAGE 6   

 304   2                      break;
 305   2              case CODE_SHIYIHAOG:
 306   2                      nMp3StartPos = MP3_TIANJIN_START;
 307   2                      nMp3Size = MP3_TIANJIN_SIZE;
 308   2                      //UartSendStr("电动窗");
 309   2                      Buff_Dat[2]=0x5B;
 310   2                      Buff_Dat[3]=0xD0;
 311   2                      break;
 312   2              case CODE_DDCK:
 313   2                      nMp3StartPos = MP3_CHONGQING_START;
 314   2                      nMp3Size = MP3_CHONGQING_SIZE;
 315   2                      //UartSendStr("照明灯");
 316   2                      Buff_Dat[2]=0x5C;
 317   2                      Buff_Dat[3]=0xD1;
 318   2                      break;
 319   2              case CODE_DDCG:
 320   2                      nMp3StartPos = MP3_CHONGQING_START;
 321   2                      nMp3Size = MP3_CHONGQING_SIZE;
 322   2                      //UartSendStr("照明灯");
 323   2                      Buff_Dat[2]=0x5C;
 324   2                      Buff_Dat[3]=0xD0;
 325   2                      break;   */
 326   2              
 327   2              default:
 328   2                      break;          
 329   2              }
 330   1      //      UartSendStr(Buff_Dat);
 331   1      //      LD_Init_Common();                 //公共初始化代码
 332   1      //      LD_Init_MP3();                    //MP3初始化
 333   1      //      LD_AdjustMIX2SPVolume(15);//设定输出音量
 334   1      //      LD_Play();
 335   1      }
 336          
 337          
 338          /**************************************************************** 
 339          函数名称： RunASR 
 340          功    能：  运行LD3320语音识别
 341          入口参数： 无 
 342          返回值  ： 1为成功
 343          修    改： 2010-2-1
 344          ****************************************************************/ 
 345          uint8 RunASR()
 346          {
 347   1              uint8 i=0;
 348   1              uint8 asrflag=0;
 349   1              for (i=0; i<5; i++)
 350   1              {
 351   2                      LD_AsrStart();
 352   2                      delay(100);
 353   2                      if (LD_AsrAddFixed()==0)
 354   2                      {
 355   3                              LD_reset();
 356   3                              delay(100);
 357   3                              continue;
 358   3                      }
 359   2                      delay(10);
 360   2                      if (LD_AsrRun() == 0)
 361   2                      {
 362   3                              LD_reset();
 363   3                              delay(100);
 364   3                              continue;
 365   3                      }
C51 COMPILER V8.18   MAIN                                                                  08/13/2011 17:58:06 PAGE 7   

 366   2      
 367   2                      asrflag=1;
 368   2                      break;
 369   2              }
 370   1      
 371   1              return asrflag;
 372   1      }
 373          
 374          


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    783    ----
   CONSTANT SIZE    =     24    ----
   XDATA SIZE       =   ----    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =   ----      10
   IDATA SIZE       =      1       1
   BIT SIZE         =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
